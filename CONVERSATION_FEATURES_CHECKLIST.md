# CHTL对话中提到的特征实现清单

## ✅ 已实现的特征

### 统一扫描器基础
- [x] 基于上下文的精确扫描
- [x] 不将无修饰字面量作为CHTL JS判断条件
- [x] 增强选择器检测 `{{CSS selector}}`
- [x] 箭头操作符检测 `->`
- [x] 基础的CHTL JS函数调用检测
- [x] 虚对象语法检测 `vir`
- [x] 无修饰字面量基础扫描

### 模块系统基础
- [x] CMOD三同名规则验证
- [x] CJMOD二同名规则验证
- [x] 混合模块结构（CMOD/CJMOD分离）
- [x] 子模块在src内部的结构
- [x] 珂朵莉和由比滨结衣模块基础结构

## ⚠️ 需要完善/实现的特征

### 1. 统一扫描器高级功能
- [ ] **可变长度切片机制**
  - [ ] 检查下一个片段是否可组成完整代码片段
  - [ ] 向前扩增切片范围
  - [ ] 按最小语法单元二次切割（如`{{box}}->click` → `{{box}}->` + `click`）
- [ ] **上下文聚合机制**
  - [ ] 多个连续CHTL/CHTL JS片段的适当聚合
  - [ ] 避免过度细分

### 2. CHTL JS完整功能实现
- [ ] **listen增强监听器**
  - [ ] 支持所有JavaScript事件（100+事件）
  - [ ] 无序键值对支持
  - [ ] 可选键值对支持
  - [ ] 智能默认值处理
- [ ] **delegate事件委托系统**
  - [ ] 支持所有JavaScript事件
  - [ ] 全局事件注册表
  - [ ] 冒泡特性检查
  - [ ] 兼容性验证
- [ ] **animate动画系统完整实现**
  - [ ] requestAnimationFrame封装
  - [ ] 关键帧支持
  - [ ] 缓动函数验证
  - [ ] 性能优化（GPU加速）
  - [ ] 动画序列支持
- [ ] **vir虚对象完整实现**
  - [ ] 编译时函数引用表
  - [ ] 运行时转换机制
  - [ ] iNeverAway标记函数
  - [ ] 状态重载支持
- [ ] **无序键值对系统**
  - [ ] 键值对任意顺序处理
  - [ ] 智能重排序（target优先，事件次之，配置最后）
- [ ] **可选键值对系统**
  - [ ] 键值对可选性支持
  - [ ] 自动默认值提供
  - [ ] 运行时必需键值对验证

### 3. 自动添加系统（核心功能）
- [ ] **局部style自动添加规则**
  - [ ] 第一个类选择器自动添加为class属性
  - [ ] 第一个id选择器自动添加为id属性
  - [ ] `&`语法：类优先，id次之
  - [ ] 不重复添加已存在的class/id
- [ ] **局部script自动添加规则**
  - [ ] `{{.xxx}}`触发class自动添加（如果元素无class且style未添加）
  - [ ] `{{#xxx}}`触发id自动添加（如果元素无id且style未添加）
  - [ ] `{{xxx}}`不触发自动添加
  - [ ] `{{&}}`语法：id优先，class次之
  - [ ] "缺什么，自动添加什么"的完整逻辑

### 4. 语法约束器系统
- [ ] **全局样式块约束**
  - [ ] 允许的语法元素白名单验证
  - [ ] 模板变量、自定义变量支持检查
  - [ ] 样式组继承验证
  - [ ] 原始嵌入支持
- [ ] **非局部script约束**
  - [ ] CHTL语法禁用（除注释和原始嵌入）
  - [ ] 语法违规检测和报错
- [ ] **局部样式块约束**
  - [ ] 与全局样式块相同的约束规则
- [ ] **局部script约束**
  - [ ] 允许的CHTL语法元素验证
  - [ ] 特供语法`{{&}}`支持

### 5. RAII状态机与上下文管理
- [ ] **RAII状态管理器**
  - [ ] 自动化状态生命周期管理
  - [ ] 异常安全的状态清理
- [ ] **上下文管理协助器**
  - [ ] AST节点状态标记
  - [ ] 解析器状态支持
  - [ ] 生成器状态支持
- [ ] **状态机集成**
  - [ ] 与扫描器协同工作
  - [ ] 状态转换验证

### 6. 增强Import功能
- [ ] **@Html、@Style、@JavaScript导入规则**
  - [ ] 无`as`语法处理
  - [ ] 有`as`语法的原始嵌入节点创建
  - [ ] 路径解析规则（文件名、具体文件名、文件夹报错）
- [ ] **@Chtl导入规则**
  - [ ] 官方模块目录优先搜索
  - [ ] 当前目录module文件夹次优先
  - [ ] cmod文件优先匹配
  - [ ] 通配符支持（`*`、`?`）
- [ ] **@CJmod导入规则**
  - [ ] 仅匹配cjmod文件
  - [ ] 相同的路径搜索策略
- [ ] **循环依赖检测**
- [ ] **重复导入处理**

### 7. 官方模块系统
- [ ] **chtl::前缀支持**
  - [ ] `[Import] @Chtl from chtl::模块名`语法
  - [ ] 官方模块路径解析
- [ ] **模块分类系统**
  - [ ] CMOD/Cmod/cmod文件夹支持
  - [ ] CJMOD/CJmod/cjmod文件夹支持

### 8. 完整的编译器架构
- [ ] **CompilerDispatcher完整实现**
  - [ ] 智能片段分发
  - [ ] 编译器兼容性检查
  - [ ] 并行编译支持
  - [ ] 结果合并
- [ ] **各编译器统一接口**
  - [ ] 解决Token类型冲突
  - [ ] 统一的CompilationResult结构
  - [ ] 错误处理统一化

## 🎯 实现优先级

### 高优先级（立即实现）
1. 可变长度切片机制
2. 自动添加系统（核心功能）
3. CHTL JS完整功能（listen, delegate, animate, vir）
4. 语法约束器系统

### 中优先级
5. RAII状态机与上下文管理
6. 增强Import功能
7. 官方模块系统

### 低优先级
8. 编译器架构完善
9. 性能优化
10. 错误处理增强

## 📝 实现说明

每个功能都需要：
1. 严格按照对话中的描述实现
2. 与现有架构兼容
3. 完整的测试覆盖
4. 详细的文档说明
5. 不破坏已有功能

**重要**：所有实现都必须基于对话内容，不得添加对话中未提及的功能或修改已明确的规则。