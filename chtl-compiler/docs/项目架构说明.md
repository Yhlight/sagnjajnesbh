# CHTL 编译器项目架构说明

## 项目概述
CHTL 编译器是一个基于 C++17 开发的超文本语言编译器，严格遵循 CHTL 语法文档实现。项目采用模块化设计，将 CHTL 和 CHTL JS 作为完全独立的编译系统。

## 核心架构原则

### 1. 严格的模块分离
- **CHTL 编译器**：独立的文件体系，包含自己的 Token、GlobalMap、State、Context、Lexer
- **CHTL JS 编译器**：完全独立的架构，不与 CHTL 混用任何组件
- **CSS/JS 编译器**：基于 ANTLR4 的独立编译器

### 2. 统一扫描器架构
```
CHTL源代码 → CHTLUnifiedScanner → 代码片段 → CompilerDispatcher → 各编译器
```

### 3. 编译流程
1. **扫描阶段**：CHTLUnifiedScanner 精准切割代码
2. **调度阶段**：CompilerDispatcher 分发片段到对应编译器
3. **编译阶段**：各编译器独立处理对应片段
4. **合并阶段**：结果合并器生成最终 HTML

## 目录结构

```
chtl-compiler/
├── src/                    # 源代码目录
│   ├── scanner/           # 统一扫描器
│   ├── chtl/              # CHTL 编译器
│   │   ├── lexer/         # 词法分析器
│   │   ├── parser/        # 语法分析器
│   │   ├── ast/           # AST 节点
│   │   ├── generator/     # 代码生成器
│   │   ├── state/         # 状态机
│   │   └── context/       # 上下文管理
│   ├── chtl_js/           # CHTL JS 编译器（独立架构）
│   │   ├── lexer/         # 独立的词法分析器
│   │   ├── parser/        # 独立的语法分析器
│   │   ├── ast/           # 独立的 AST 节点
│   │   ├── generator/     # 独立的代码生成器
│   │   ├── state/         # 独立的状态机
│   │   └── context/       # 独立的上下文管理
│   ├── css/               # CSS 编译器（ANTLR）
│   ├── js/                # JavaScript 编译器（ANTLR）
│   ├── dispatcher/        # 编译器调度器
│   ├── merger/            # 结果合并器
│   ├── module/            # 模块系统（CMOD/CJMOD）
│   └── utils/             # 工具类
├── include/               # 头文件目录（与 src 结构对应）
├── tests/                 # 测试目录
├── docs/                  # 文档目录
├── module/                # 官方模块目录
├── build/                 # 构建目录
└── scripts/               # 脚本目录
```

## 关键组件说明

### 1. CHTLUnifiedScanner（统一扫描器）
- 基于可变长度切片工作
- 智能识别代码片段边界
- 保证 CHTL/CHTL JS 代码的最小单元切割
- 上下文感知，避免过度细分

### 2. CHTL 编译器
独立的编译器系统，包含：
- **Token 系统**：定义 CHTL 所有词法单元
- **GlobalMap**：全局符号表和映射表
- **State Machine**：RAII 模式的状态机
- **Context Manager**：上下文管理器
- **Parser/Generator**：解析器和生成器

### 3. CHTL JS 编译器
完全独立的编译器系统，包含：
- **独立的 Token 系统**：CHTL JS 特有的词法单元
- **独立的 GlobalMap**：CHTL JS 专用映射表
- **独立的状态机和上下文**：不与 CHTL 共享
- **特殊功能支持**：增强选择器、虚对象、事件委托等

### 4. 模块系统
- **CMOD**：CHTL 模块打包和管理
- **CJMOD**：C++ 扩展模块系统
- **Import 系统**：路径解析、循环依赖检测
- **Namespace**：命名空间管理和冲突检测

### 5. 约束器
- 全局样式块语法约束
- 局部样式块语法约束
- Script 块语法边界控制
- 确保各编译器只处理允许的语法

## 开发规范

### 1. 代码规范
- 严格遵循 C++17 标准
- 使用 RAII 管理资源
- 所有类使用命名空间 `chtl`
- 编码使用 UTF-8

### 2. 错误处理
- 使用异常处理错误
- 提供详细的错误位置信息
- 支持错误恢复机制

### 3. 性能要求
- 扫描器使用流式处理
- 避免不必要的字符串拷贝
- 合理使用移动语义

### 4. 测试要求
- 每个组件必须有单元测试
- 提供集成测试用例
- 覆盖所有语法特性

## 编译和构建

```bash
# 创建构建目录
mkdir build && cd build

# 配置项目
cmake ..

# 编译
make -j4

# 运行测试
make test

# 安装
make install
```

## 注意事项

1. **不要混用架构**：CHTL 和 CHTL JS 必须完全分离
2. **严格遵循语法文档**：不私自扩展语法
3. **保持模块独立性**：各编译器独立管理自己的文件体系
4. **CHTL JS 不是 JS**：CHTL JS 编译器不处理 JavaScript 内容