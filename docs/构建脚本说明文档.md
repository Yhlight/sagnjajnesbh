# CHTL构建脚本说明文档

## 📋 概述

CHTL项目提供了完整的跨平台构建脚本系统，支持Windows、Linux和macOS平台。这些脚本自动化了编译器构建、VSCode扩展打包和模块管理的全部流程，确保开发者能够轻松地构建和分发CHTL项目。

## 📁 脚本目录结构

```
scripts/
├── windows/           # Windows平台脚本 (.bat)
│   ├── build_compiler_release.bat
│   ├── build_compiler_debug.bat
│   ├── build_vscode_plugin.bat
│   ├── build_unified.bat
│   ├── package_cmod.bat
│   ├── package_cjmod.bat
│   └── package_unified.bat
├── linux/             # Linux平台脚本 (.sh)
│   ├── build_compiler_release.sh
│   ├── build_compiler_debug.sh
│   ├── build_vscode_plugin.sh
│   ├── build_unified.sh
│   ├── package_cmod.sh
│   ├── package_cjmod.sh
│   └── package_unified.sh
└── macos/             # macOS平台脚本 (.sh)
    ├── build_compiler_release.sh
    ├── build_compiler_debug.sh
    ├── build_vscode_plugin.sh
    ├── build_unified.sh
    ├── package_cmod.sh
    ├── package_cjmod.sh
    └── package_unified.sh
```

## 🔧 编译器构建脚本

### Release构建脚本

**用途：** 构建优化的生产版本CHTL编译器

**文件位置：**
- Windows: `scripts/windows/build_compiler_release.bat`
- Linux: `scripts/linux/build_compiler_release.sh`
- macOS: `scripts/macos/build_compiler_release.sh`

**使用方法：**
```bash
# Windows
cd scripts\windows
build_compiler_release.bat

# Linux/macOS
cd scripts/linux    # 或 scripts/macos
./build_compiler_release.sh
```

**脚本功能：**
1. 创建 `build/release` 构建目录
2. 使用CMake配置Release构建
3. 编译CHTL编译器（启用优化）
4. 将生成的可执行文件复制到 `bin/` 目录
5. 设置适当的文件权限（Linux/macOS）

**生成文件：**
- Windows: `bin/chtl-compiler.exe`
- Linux/macOS: `bin/chtl-compiler`

**构建选项：**
- 编译器优化：O3级别
- 调试信息：已移除
- 并行构建：启用
- 静态链接：部分依赖

### Debug构建脚本

**用途：** 构建包含调试信息的开发版本编译器

**文件位置：**
- Windows: `scripts/windows/build_compiler_debug.bat`
- Linux: `scripts/linux/build_compiler_debug.sh`
- macOS: `scripts/macos/build_compiler_debug.sh`

**使用方法：**
```bash
# Windows
cd scripts\windows
build_compiler_debug.bat

# Linux/macOS
cd scripts/linux    # 或 scripts/macos
./build_compiler_debug.sh
```

**脚本功能：**
1. 创建 `build/debug` 构建目录
2. 使用CMake配置Debug构建
3. 编译CHTL编译器（包含调试信息）
4. 将生成的可执行文件复制到 `bin/debug/` 目录

**生成文件：**
- Windows: `bin/debug/chtl-compiler.exe`
- Linux/macOS: `bin/debug/chtl-compiler`

**构建特性：**
- 调试信息：完整保留
- 优化级别：O0（无优化）
- 断言：启用
- 内存检测：可选启用

## 🔌 VSCode插件构建脚本

**用途：** 构建CHTL语言的VSCode扩展插件

**文件位置：**
- Windows: `scripts/windows/build_vscode_plugin.bat`
- Linux: `scripts/linux/build_vscode_plugin.sh`
- macOS: `scripts/macos/build_vscode_plugin.sh`

**使用方法：**
```bash
# Windows
cd scripts\windows
build_vscode_plugin.bat

# Linux/macOS
cd scripts/linux    # 或 scripts/macos
./build_vscode_plugin.sh
```

**前置要求：**
- Node.js 16.0+
- npm 8.0+
- vsce（Visual Studio Code Extension Manager）

**脚本功能：**
1. 检查Node.js和npm环境
2. 进入VSCode扩展目录
3. 安装项目依赖（npm install）
4. 编译TypeScript源码（npm run compile）
5. 使用vsce打包扩展（.vsix格式）
6. 将生成的扩展包复制到 `dist/` 目录

**生成文件：**
- `dist/chtl-*.vsix`（VSCode扩展包）

**插件功能：**
- CHTL语法高亮
- 智能代码补全
- 错误诊断和提示
- 内置编译器集成
- 模块自动解析
- 冲突检测和解决

## 🎯 统一构建脚本

**用途：** 一键完成整个CHTL项目的构建流程

**文件位置：**
- Windows: `scripts/windows/build_unified.bat`
- Linux: `scripts/linux/build_unified.sh`
- macOS: `scripts/macos/build_unified.sh`

**使用方法：**
```bash
# Windows
cd scripts\windows
build_unified.bat

# Linux/macOS
cd scripts/linux    # 或 scripts/macos
./build_unified.sh
```

**统一构建流程：**

### 第一阶段：编译器构建
1. 调用Release编译器构建脚本
2. 验证编译器可执行性
3. 输出编译器版本信息

### 第二阶段：模块自动打包
1. **Chtholly模块打包：**
   - 遍历 `Chtholly/CMOD/` 下的所有组件
   - 自动调用CMOD打包脚本
   - 遍历 `Chtholly/CJMOD/` 下的所有扩展
   - 自动调用CJMOD打包脚本

2. **Yuigahama模块打包：**
   - 遍历 `Yuigahama/CMOD/` 下的所有组件
   - 自动调用CMOD打包脚本

### 第三阶段：VSCode扩展准备
1. **创建扩展资源目录：**
   ```
   vscode-chtl-extension/assets/
   ├── bin/           # 编译器可执行文件
   └── modules/       # 打包好的模块文件
   ```

2. **复制核心文件：**
   - 编译器可执行文件 → `assets/bin/`
   - 所有.cmod和.cjmod包 → `assets/modules/`

3. **构建VSCode扩展：**
   - 调用VSCode插件构建脚本
   - 生成包含所有资源的完整扩展包

**生成产物：**
- `bin/chtl-compiler.exe`（编译器）
- `dist/modules/*.cmod`（CMOD模块包）
- `dist/modules/*.cjmod`（CJMOD模块包）
- `dist/chtl-*.vsix`（完整VSCode扩展）

## 📦 模块打包脚本

### CMOD打包脚本

**用途：** 将CHTL组件模块打包为.cmod格式

**文件位置：**
- Windows: `scripts/windows/package_cmod.bat`
- Linux: `scripts/linux/package_cmod.sh`
- macOS: `scripts/macos/package_cmod.sh`

**使用方法：**
```bash
# Windows
scripts\windows\package_cmod.bat Chtholly\CMOD\Core

# Linux/macOS
scripts/linux/package_cmod.sh Chtholly/CMOD/Core
```

**脚本功能：**
1. 验证模块路径存在性
2. 提取模块名称
3. 创建临时打包目录
4. 复制模块源码结构：
   - `src/` 目录（包含.chtl源文件）
   - `info/` 目录（包含模块信息）
5. 验证必要文件存在：
   - `src/ModuleName.chtl`
   - `info/ModuleName.chtl`
6. 创建.cmod压缩包
7. 清理临时文件

**模块结构验证：**
```
ModuleName/
├── src/
│   └── ModuleName.chtl    ✓ 必需
└── info/
    └── ModuleName.chtl    ✓ 必需
```

### CJMOD打包脚本

**用途：** 将C++扩展模块打包为.cjmod格式

**文件位置：**
- Windows: `scripts/windows/package_cjmod.bat`
- Linux: `scripts/linux/package_cjmod.sh`
- macOS: `scripts/macos/package_cjmod.sh`

**使用方法：**
```bash
# Windows
scripts\windows\package_cjmod.bat Chtholly\CJMOD\printMylove

# Linux/macOS
scripts/linux/package_cjmod.sh Chtholly/CJMOD/printMylove
```

**脚本功能：**
1. 验证模块路径存在性
2. 提取模块名称
3. 创建临时打包目录
4. 复制模块源码结构：
   - `src/` 目录（包含C++源文件）
   - `info/` 目录（包含模块信息）
5. 验证C++文件存在：
   - `.cpp` 源文件
   - `.h` 头文件
6. 验证信息文件：
   - `info/ModuleName.chtl`
7. 创建.cjmod压缩包
8. 清理临时文件

**模块结构验证：**
```
ModuleName/
├── src/
│   ├── ModuleName.cpp     ✓ 建议
│   ├── ModuleName.h       ✓ 建议
│   └── *.cpp, *.h         ✓ 其他源文件
└── info/
    └── ModuleName.chtl    ✓ 必需
```

### 统一打包脚本

**用途：** 智能识别模块类型并自动调用相应的打包脚本

**文件位置：**
- Windows: `scripts/windows/package_unified.bat`
- Linux: `scripts/linux/package_unified.sh`
- macOS: `scripts/macos/package_unified.sh`

**使用方法：**
```bash
# Windows
scripts\windows\package_unified.bat Chtholly\CMOD\Core
scripts\windows\package_unified.bat Chtholly\CJMOD\printMylove

# Linux/macOS
scripts/linux/package_unified.sh Chtholly/CMOD/Core
scripts/linux/package_unified.sh Chtholly/CJMOD/printMylove
```

**智能识别逻辑：**
1. **路径模式识别：**
   - 包含 "CMOD" → 识别为CMOD模块
   - 包含 "CJMOD" → 识别为CJMOD模块

2. **内容自动检测：**
   - 存在C++文件（.cpp/.h） → CJMOD模块
   - 仅存在CHTL文件（.chtl） → CMOD模块

3. **调用相应脚本：**
   - CMOD → 调用 `package_cmod`
   - CJMOD → 调用 `package_cjmod`

## ⚙️ 脚本配置和自定义

### 环境变量配置

**Windows环境变量：**
```batch
set CMAKE_GENERATOR=Visual Studio 17 2022
set CMAKE_PLATFORM=x64
set BUILD_PARALLEL=ON
set VCPKG_ROOT=C:\vcpkg
```

**Linux/macOS环境变量：**
```bash
export CMAKE_BUILD_TYPE=Release
export CMAKE_GENERATOR=Unix Makefiles
export BUILD_PARALLEL=$(nproc)  # Linux
export BUILD_PARALLEL=$(sysctl -n hw.ncpu)  # macOS
```

### 构建选项自定义

**编译器构建选项：**
```cmake
# Release构建
-DCMAKE_BUILD_TYPE=Release
-DCMAKE_CXX_FLAGS="-O3 -DNDEBUG"
-DBUILD_SHARED_LIBS=OFF

# Debug构建
-DCMAKE_BUILD_TYPE=Debug
-DCMAKE_CXX_FLAGS="-g -O0"
-DENABLE_ASSERTIONS=ON
```

**VSCode扩展构建选项：**
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "strict": true,
    "sourceMap": true
  },
  "vsce": {
    "packagedDependencies": ["*"],
    "ignoreFile": ".vscodeignore"
  }
}
```

## 🔍 故障排除

### 常见构建问题

**问题1：CMake配置失败**
```
错误：CMake Error: Could not find CMAKE_CXX_COMPILER
解决：
1. 确保安装了合适的C++编译器
2. Windows: 安装Visual Studio 2022
3. Linux: sudo apt install build-essential cmake
4. macOS: xcode-select --install
```

**问题2：ANTLR4依赖缺失**
```
错误：Could not find antlr4-runtime
解决：
1. 确保antlr-4.13.2-complete.jar在项目根目录
2. 设置JAVA_HOME环境变量
3. 验证Java版本：java -version
```

**问题3：Node.js版本不兼容**
```
错误：This package requires Node.js >= 16.0.0
解决：
1. 升级Node.js到16.0+
2. 使用nvm管理Node.js版本
3. nvm install 16 && nvm use 16
```

**问题4：权限问题（Linux/macOS）**
```
错误：Permission denied
解决：
1. chmod +x scripts/linux/*.sh
2. chmod +x scripts/macos/*.sh
3. 或使用 bash scripts/linux/script_name.sh
```

**问题5：模块路径不存在**
```
错误：Module path not found
解决：
1. 检查模块路径拼写
2. 确保使用正确的路径分隔符
3. Windows: Chtholly\CMOD\Core
4. Linux/macOS: Chtholly/CMOD/Core
```

### 性能优化

**并行构建优化：**
```bash
# Windows
cmake --build . --config Release --parallel %NUMBER_OF_PROCESSORS%

# Linux
make -j$(nproc)

# macOS
make -j$(sysctl -n hw.ncpu)
```

**磁盘空间优化：**
```bash
# 清理构建缓存
rm -rf build/
rm -rf node_modules/

# 清理临时文件
find . -name "*.tmp" -delete
find . -name "*.log" -delete
```

**内存使用优化：**
```cmake
# 减少并行任务数
set(CMAKE_BUILD_PARALLEL_LEVEL 2)

# 使用链接时优化
set(CMAKE_INTERPROCEDURAL_OPTIMIZATION ON)
```

## 📊 构建脚本性能指标

### 构建时间基准

**编译器构建时间（基于硬件配置）：**

| 配置 | Release构建 | Debug构建 | 说明 |
|------|-------------|-----------|------|
| 高端工作站 | 2-3分钟 | 3-4分钟 | 16核CPU, 32GB RAM, SSD |
| 中端开发机 | 5-8分钟 | 8-12分钟 | 8核CPU, 16GB RAM, SSD |
| 入门级设备 | 15-20分钟 | 20-30分钟 | 4核CPU, 8GB RAM, HDD |

**VSCode扩展构建时间：**
- TypeScript编译：30-60秒
- 依赖安装：1-3分钟
- 扩展打包：10-20秒

**模块打包时间：**
- 单个CMOD模块：5-10秒
- 单个CJMOD模块：10-15秒
- 所有模块（统一构建）：2-5分钟

### 磁盘空间使用

**构建产物大小：**
- 编译器可执行文件：20-50MB
- VSCode扩展包：10-20MB
- 单个CMOD包：100KB-1MB
- 单个CJMOD包：500KB-5MB
- 完整构建产物：100-200MB

## 🚀 持续集成配置

### GitHub Actions示例

**构建工作流配置：**
```yaml
name: CHTL Build Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'adopt'
        
    - name: Build Compiler
      shell: bash
      run: |
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          scripts/windows/build_compiler_release.bat
        else
          scripts/linux/build_compiler_release.sh
        fi
        
    - name: Build VSCode Extension
      shell: bash
      run: |
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          scripts/windows/build_vscode_plugin.bat
        else
          scripts/linux/build_vscode_plugin.sh
        fi
        
    - name: Package Modules
      shell: bash
      run: |
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          scripts/windows/package_unified.bat Chtholly/CMOD/Core
        else
          scripts/linux/package_unified.sh Chtholly/CMOD/Core
        fi
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: chtl-build-${{ matrix.os }}
        path: |
          bin/
          dist/
```

## 📚 相关文档

- [项目构建指南](./项目构建指南.md) - 完整的构建流程说明
- [打包脚本说明文档](./打包脚本说明文档.md) - 模块打包详细说明
- [CHTL语法文档](./CHTL语法文档更新版.md) - 语法规范
- [珂朵莉模块使用文档](./珂朵莉模块使用文档.md) - 混合模块使用
- [由比滨结衣模块使用文档](./由比滨结衣模块使用文档.md) - 音乐模块使用

## 📄 许可证

本脚本系统遵循MIT许可证，详见 [LICENSE](../LICENSE) 文件。