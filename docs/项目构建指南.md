# CHTL项目构建指南

## 📋 概述

CHTL（C++ HyperText Language）是基于C++实现的超文本语言编译器，提供了完整的开发工具链，包括编译器、VSCode扩展和模块系统。本指南详细说明如何构建和使用CHTL项目。

## 🔧 系统要求

### Windows
- Visual Studio 2022 (或更高版本)
- CMake 3.16+
- Node.js 16.0+
- npm 8.0+
- PowerShell 5.0+

### Linux
- GCC 9.0+ 或 Clang 10.0+
- CMake 3.16+
- Make
- Node.js 16.0+
- npm 8.0+
- zip/unzip

### macOS
- Xcode Command Line Tools
- CMake 3.16+
- Node.js 16.0+
- npm 8.0+
- zip/unzip

## 📁 项目结构

```
CHTL/
├── src/                    # 编译器源代码
│   ├── CHTL/              # CHTL核心解析器
│   ├── CHTLJS/            # CHTL JS扩展
│   ├── Scanner/           # 统一扫描器
│   ├── Dispatcher/        # 编译器调度器
│   └── main.cpp           # 主程序入口
├── include/               # 头文件
├── tests/                 # 测试文件
├── examples/              # 示例文件
├── scripts/               # 构建脚本
│   ├── windows/           # Windows脚本
│   ├── linux/             # Linux脚本
│   └── macos/             # macOS脚本
├── vscode-chtl-extension/ # VSCode扩展
├── Chtholly/              # 珂朵莉模块
│   ├── CMOD/              # CMOD组件
│   └── CJMOD/             # CJMOD组件
├── Yuigahama/             # 由比滨结衣模块
│   └── CMOD/              # 纯CMOD组件
└── docs/                  # 项目文档
```

## 🚀 快速开始

### 方法一：使用统一构建脚本（推荐）

这是最简单的方式，会自动完成所有构建步骤：

**Windows:**
```cmd
cd scripts\windows
build_unified.bat
```

**Linux/macOS:**
```bash
cd scripts/linux    # 或 scripts/macos
./build_unified.sh
```

统一构建脚本会执行：
1. 构建CHTL编译器（Release版本）
2. 自动打包所有模块（Chtholly和Yuigahama）
3. 构建VSCode扩展并嵌入编译器和模块

### 方法二：分步构建

如果需要更精确的控制，可以分步执行：

#### 1. 构建编译器

**Release版本:**
```bash
# Windows
scripts\windows\build_compiler_release.bat

# Linux/macOS
scripts/linux/build_compiler_release.sh
scripts/macos/build_compiler_release.sh
```

**Debug版本:**
```bash
# Windows
scripts\windows\build_compiler_debug.bat

# Linux/macOS
scripts/linux/build_compiler_debug.sh
scripts/macos/build_compiler_debug.sh
```

#### 2. 打包模块

**打包单个CMOD模块:**
```bash
# Windows
scripts\windows\package_cmod.bat Chtholly\CMOD\Core

# Linux/macOS
scripts/linux/package_cmod.sh Chtholly/CMOD/Core
```

**打包单个CJMOD模块:**
```bash
# Windows
scripts\windows\package_cjmod.bat Chtholly\CJMOD\printMylove

# Linux/macOS
scripts/linux/package_cjmod.sh Chtholly/CJMOD/printMylove
```

**智能打包（自动识别类型）:**
```bash
# Windows
scripts\windows\package_unified.bat Chtholly\CMOD\Core

# Linux/macOS
scripts/linux/package_unified.sh Chtholly/CMOD/Core
```

#### 3. 构建VSCode扩展

```bash
# Windows
scripts\windows\build_vscode_plugin.bat

# Linux/macOS
scripts/linux/build_vscode_plugin.sh
scripts/macos/build_vscode_plugin.sh
```

## 📦 构建输出

成功构建后，您将获得以下文件：

### 编译器
- **Windows:** `bin/chtl-compiler.exe`
- **Linux/macOS:** `bin/chtl-compiler`

### 模块包
- **CMOD包:** `dist/modules/*.cmod`
- **CJMOD包:** `dist/modules/*.cjmod`

### VSCode扩展
- **扩展包:** `dist/chtl-*.vsix`

## 🧪 测试构建

### 基本功能测试

```bash
# 测试编译器
./bin/chtl-compiler --help

# 编译示例文件
./bin/chtl-compiler examples/test.chtl -o output.html

# 扫描测试
./bin/chtl-compiler --scan-only examples/complex_test.chtl
```

### 模块测试

```bash
# 验证CMOD包
cd examples
../bin/chtl-compiler chtholly_test_example.chtl

# 验证CJMOD包  
../bin/chtl-compiler test_chtljs.chtl
```

## 🐛 常见问题

### Windows构建问题

**Q: CMake配置失败**
```
A: 确保安装了Visual Studio 2022并包含C++工具链
   检查CMake版本：cmake --version
```

**Q: 编译器链接错误**
```
A: 检查ANTLR4依赖：
   - antlr-4.13.2-complete.jar 应在项目根目录
   - 确保环境变量JAVA_HOME设置正确
```

### Linux构建问题

**Q: GCC版本过低**
```
A: 升级GCC到9.0+:
   sudo apt update
   sudo apt install gcc-9 g++-9
```

**Q: 依赖缺失**
```
A: 安装构建依赖:
   sudo apt install build-essential cmake uuid-dev
```

### macOS构建问题

**Q: Xcode Command Line Tools缺失**
```
A: 安装开发工具:
   xcode-select --install
```

**Q: 权限问题**
```
A: 确保脚本有执行权限:
   chmod +x scripts/macos/*.sh
```

### VSCode扩展问题

**Q: npm install失败**
```
A: 清理缓存重试:
   cd vscode-chtl-extension
   npm cache clean --force
   npm install
```

**Q: vsce命令不存在**
```
A: 安装vsce:
   npm install -g vsce
```

## 🔍 高级构建选项

### CMake构建选项

```bash
# 启用调试信息
cmake -DCMAKE_BUILD_TYPE=Debug

# 指定编译器
cmake -DCMAKE_CXX_COMPILER=g++-9

# 自定义安装路径
cmake -DCMAKE_INSTALL_PREFIX=/usr/local
```

### 并行构建

```bash
# Windows (使用所有CPU核心)
cmake --build . --config Release --parallel

# Linux/macOS
make -j$(nproc)        # Linux
make -j$(sysctl -n hw.ncpu)  # macOS
```

### 交叉编译

对于需要在不同平台间分发的情况，可以使用Docker或虚拟机进行交叉编译。

## 📊 性能优化

### Release构建优化

Release版本已启用以下优化：
- O3级别优化
- 链接时优化（LTO）
- 调试信息剥离
- 静态链接（减少依赖）

### 构建时间优化

```bash
# 使用ccache加速编译（Linux/macOS）
sudo apt install ccache  # Linux
brew install ccache       # macOS

export CXX="ccache g++"
```

## 🔄 持续集成

项目支持CI/CD流水线，可以参考 `.github/workflows/` 中的配置文件设置自动构建。

### GitHub Actions示例

```yaml
name: Build CHTL
on: [push, pull_request]
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
    - uses: actions/checkout@v3
    - name: Build
      run: scripts/${{ runner.os }}/build_unified.sh
```

## 📚 相关文档

- [CHTL语法文档](./CHTL语法文档.md) - 完整语法说明
- [CMOD开发指南](./CMOD模块开发指南.md) - 模块开发教程
- [CJMOD开发指南](./CJMOD模块开发指南.md) - C++扩展开发
- [珂朵莉模块使用文档](./珂朵莉模块使用文档.md) - 珂朵莉模块说明
- [由比滨结衣模块使用文档](./由比滨结衣模块使用文档.md) - 由比滨结衣模块说明

## 🤝 贡献

欢迎提交Issue和Pull Request！构建相关问题请提供：
1. 操作系统和版本
2. 编译器版本
3. 完整的错误日志
4. 复现步骤

## 📄 许可证

本项目采用MIT许可证，详见 [LICENSE](../LICENSE) 文件。