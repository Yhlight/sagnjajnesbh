# CHTL 项目构建指南

## 概述

本指南详细说明如何构建 CHTL 编译器项目，包括编译器本体、VSCode 插件以及模块打包。

## 系统要求

### Windows
- Windows 10/11 (64位)
- Visual Studio 2019/2022 或 Visual Studio Build Tools
- CMake 3.16+
- Node.js 16+ (用于 VSCode 插件)
- PowerShell 5.0+

### Linux
- Ubuntu 20.04+ / CentOS 8+ / 其他现代 Linux 发行版
- GCC 9+ 或 Clang 10+
- CMake 3.16+
- Node.js 16+ (用于 VSCode 插件)
- 构建工具包：`build-essential`

### macOS
- macOS 10.15+
- Xcode Command Line Tools
- CMake 3.16+
- Node.js 16+ (用于 VSCode 插件)
- Homebrew (推荐)

## 依赖项安装

### ANTLR4 C++ Runtime

#### Windows
```bash
# 使用 vcpkg (推荐)
vcpkg install antlr4:x64-windows

# 或手动编译 ANTLR4 runtime
```

#### Linux (Ubuntu/Debian)
```bash
sudo apt update
sudo apt install build-essential cmake nodejs npm
sudo apt install libantlr4-runtime-dev  # 如果可用
```

#### macOS
```bash
# 使用 Homebrew
brew install cmake nodejs
brew install antlr4-cpp-runtime
```

## 快速构建

### 1. 一键构建（推荐）

#### Windows
```cmd
# 构建所有组件（编译器+模块+VSCode插件）
scripts\windows\build_all.bat
```

#### Linux/macOS
```bash
# 设置权限
chmod +x scripts/linux/*.sh

# 构建所有组件
scripts/linux/build_all.sh
```

### 2. 分步构建

#### 步骤 1：构建编译器

**Release 版本：**
```cmd
# Windows
scripts\windows\build_release.bat

# Linux/macOS  
scripts/linux/build_release.sh
```

**Debug 版本：**
```cmd
# Windows
scripts\windows\build_debug.bat

# Linux/macOS
scripts/linux/build_debug.sh
```

#### 步骤 2：打包模块

**CMOD 模块：**
```cmd
# Windows
scripts\windows\pack_cmod.bat Chtholly

# Linux/macOS
scripts/linux/pack_cmod.sh Chtholly
```

**CJMOD 模块：**
```cmd
# Windows  
scripts\windows\pack_cjmod.bat ChthollyExtension

# Linux/macOS
scripts/linux/pack_cjmod.sh ChthollyExtension
```

#### 步骤 3：构建 VSCode 插件

```cmd
# Windows
scripts\windows\build_vscode_extension.bat

# Linux/macOS
scripts/linux/build_vscode_extension.sh
```

## 手动构建

### 编译器手动构建

```bash
# 创建构建目录
mkdir -p build/release
cd build/release

# 配置项目
cmake -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_CXX_STANDARD=17 \
      -DENABLE_TESTING=OFF \
      ../..

# 编译
cmake --build . --config Release --parallel

# 运行测试 (可选)
ctest --config Release
```

### VSCode 插件手动构建

```bash
# 进入插件目录
cd vscode-chtl-extension

# 安装依赖
npm install

# 编译 TypeScript
npm run compile

# 打包插件
npx vsce package
```

## 构建输出

### 目录结构
```
dist/
├── windows/          # Windows 编译器二进制文件
├── linux/            # Linux 编译器二进制文件  
├── macos/            # macOS 编译器二进制文件
└── vscode/           # VSCode 插件包
    └── chtl-extension.vsix

packages/             # 打包的模块文件
├── Chtholly.cmod
├── Yuigahama.cmod
└── *.cjmod
```

### 核心文件说明

**编译器二进制：**
- `chtl` / `chtl.exe` - 主编译器
- `chtl-scanner` / `chtl-scanner.exe` - 统一扫描器
- `*.dll` / `*.so` / `*.dylib` - 动态链接库

**模块文件：**
- `*.cmod` - CHTL 模块包（CHTL 组件）
- `*.cjmod` - CHTL JS 扩展模块包（C++ 扩展）

## 常见问题

### 1. CMake 配置失败

**问题：** 找不到 ANTLR4
```
解决方案：
- Windows: 确保安装了 vcpkg 和 ANTLR4
- Linux: 安装 libantlr4-runtime-dev
- macOS: brew install antlr4-cpp-runtime
```

### 2. 编译错误

**问题：** C++17 标准不支持
```
解决方案：
- 确保使用支持 C++17 的编译器版本
- GCC 9+, Clang 10+, MSVC 2019+
```

### 3. VSCode 插件构建失败

**问题：** npm install 失败
```
解决方案：
1. 检查 Node.js 版本 (需要 16+)
2. 清除缓存：npm cache clean --force
3. 删除 node_modules 重新安装
```

### 4. 模块打包失败

**问题：** 模块结构不正确
```
解决方案：
检查模块目录结构是否符合 CHTL 规范：

CMOD:
ModuleName/
  src/
    ModuleName.chtl
  info/
    ModuleName.chtl

CJMOD:  
ModuleName/
  src/
    *.cpp *.h
  info/
    ModuleName.chtl
```

## 开发构建

### Debug 模式
```bash
# 启用调试符号和详细日志
cmake -DCMAKE_BUILD_TYPE=Debug \
      -DENABLE_TESTING=ON \
      -DENABLE_DEBUG_SYMBOLS=ON \
      ../..
```

### 测试运行
```bash
# 运行单元测试
ctest --config Debug --verbose

# 运行集成测试
./chtl --test tests/integration/
```

## 性能优化

### Release 优化选项
```bash
cmake -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_CXX_FLAGS="-O3 -DNDEBUG" \
      -DENABLE_LTO=ON \
      ../..
```

### 并行编译
```bash
# 使用所有可用核心
cmake --build . --parallel

# 指定核心数量
cmake --build . --parallel 8
```

## 部署

### 本地安装
```bash
# 安装编译器到系统
sudo cmake --install . --prefix /usr/local

# 安装 VSCode 插件
code --install-extension dist/vscode/chtl-extension.vsix
```

### 打包分发
```bash
# 创建分发包
tar -czf chtl-compiler-linux-x64.tar.gz dist/linux/
zip -r chtl-compiler-windows-x64.zip dist/windows/
```

## 进阶配置

### 自定义编译选项
```cmake
# CMakeLists.txt 中的可配置选项
option(ENABLE_TESTING "Enable testing" OFF)
option(ENABLE_EXAMPLES "Build examples" ON)
option(ENABLE_DEBUG_SYMBOLS "Include debug symbols" OFF)
option(ENABLE_LTO "Enable Link Time Optimization" OFF)
```

### 交叉编译
```bash
# Linux -> Windows (使用 MinGW)
cmake -DCMAKE_TOOLCHAIN_FILE=cmake/mingw-w64.cmake ../..

# 为其他架构编译
cmake -DCMAKE_SYSTEM_PROCESSOR=aarch64 ../..
```

## 支持

如遇到构建问题，请：

1. 检查系统要求和依赖项
2. 查看构建日志的详细错误信息
3. 参考常见问题解决方案
4. 确保使用最新版本的构建脚本

更多技术支持请参考其他文档：
- [CHTL 编译器开发指南](CHTL编译器开发指南.md)
- [构建脚本说明](构建脚本说明.md)
- [项目架构说明](CHTL项目架构说明.md)