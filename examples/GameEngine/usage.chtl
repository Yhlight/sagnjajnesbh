// ========================================
// ğŸ® æ¸¸æˆå¼•æ“ç¤ºä¾‹ - CJMODé©±åŠ¨çš„æ¸¸æˆå¼€å‘
// ========================================

html {
    head {
        title { text { ğŸ® CJMODæ¸¸æˆå¼•æ“æ¼”ç¤º } }
        
        style {
            body {
                margin: 0;
                padding: 0;
                background: linear-gradient(45deg, #1e3c72, #2a5298);
                font-family: 'Arial', sans-serif;
                color: white;
            }
            
            .game-container {
                width: 100vw;
                height: 100vh;
                position: relative;
                overflow: hidden;
            }
            
            .game-canvas {
                width: 100%;
                height: 80%;
                background: radial-gradient(circle, #000428, #004e92);
                position: relative;
                border: 2px solid #00ff88;
            }
            
            .game-object {
                position: absolute;
                width: 20px;
                height: 20px;
                background: #ff6b6b;
                border-radius: 50%;
                box-shadow: 0 0 10px #ff6b6b;
                transition: all 0.1s ease;
            }
            
            .game-object.enemy {
                background: #ff4757;
                box-shadow: 0 0 15px #ff4757;
            }
            
            .game-object.player {
                background: #00ff88;
                box-shadow: 0 0 20px #00ff88;
                width: 25px;
                height: 25px;
            }
            
            .game-ui {
                position: absolute;
                top: 10px;
                left: 10px;
                background: rgba(0,0,0,0.8);
                padding: 15px;
                border-radius: 10px;
                border: 1px solid #00ff88;
            }
            
            .game-controls {
                position: absolute;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 10px;
            }
            
            .control-btn {
                padding: 15px 25px;
                background: linear-gradient(45deg, #667eea, #764ba2);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s ease;
            }
            
            .control-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            }
            
            .control-btn:active {
                transform: scale(0.95);
            }
        }
    }
    
    body {
        div {
            class: game-container;
            
            // æ¸¸æˆç”»å¸ƒ
            div {
                id: game-canvas;
                class: game-canvas;
            }
            
            // æ¸¸æˆUI
            div {
                id: game-ui;
                class: game-ui;
                
                h3 { text { ğŸ® CJMODæ¸¸æˆå¼•æ“ } }
                div { id: score; text { åˆ†æ•°: 0 } }
                div { id: level; text { ç­‰çº§: 1 } }
                div { id: fps; text { FPS: 60 } }
                div { id: objects; text { å¯¹è±¡: 0 } }
            }
            
            // æ¸¸æˆæ§åˆ¶
            div {
                class: game-controls;
                
                button {
                    id: start-btn;
                    class: control-btn;
                    text { ğŸš€ å¯åŠ¨æ¸¸æˆ }
                }
                
                button {
                    id: spawn-btn;
                    class: control-btn;
                    text { ğŸ‘¹ ç”Ÿæˆæ•Œäºº }
                }
                
                button {
                    id: physics-btn;
                    class: control-btn;
                    text { âš¡ ç‰©ç†å¼•æ“ }
                }
                
                button {
                    id: sound-btn;
                    class: control-btn;
                    text { ğŸ”Š éŸ³æ•ˆ }
                }
                
                button {
                    id: save-btn;
                    class: control-btn;
                    text { ğŸ’¾ ä¿å­˜æ¸¸æˆ }
                }
            }
            
            script {
                // ========================================
                // ğŸš€ ä½¿ç”¨CJMODåˆ›é€ çš„æ¸¸æˆå¼•æ“è¯­æ³•ï¼
                // ========================================
                
                let gameState = {
                    running: false,
                    score: 0,
                    level: 1,
                    playerPosition: {x: 400, y: 300},
                    enemies: [],
                    gameObjects: []
                };
                
                let gameLoop = null;
                
                // ğŸ® åˆå§‹åŒ–æ¸¸æˆå¼•æ“
                async function initGameEngine() {
                    try {
                        console.log('ğŸš€ åˆå§‹åŒ–CJMODæ¸¸æˆå¼•æ“...');
                        
                        // ğŸ”§ åˆå§‹åŒ–ç‰©ç†å¼•æ“ï¼ˆä½¿ç”¨CJMODçš„C++ç‰©ç†ç³»ç»Ÿï¼‰
                        const physicsResult = await {{initGamePhysics}}();
                        console.log('âš¡ ç‰©ç†å¼•æ“:', physicsResult);
                        
                        // ğŸ¨ åˆå§‹åŒ–æ¸²æŸ“ç³»ç»Ÿ
                        const renderResult = await {{initGameRender}}();
                        console.log('ğŸ¨ æ¸²æŸ“ç³»ç»Ÿ:', renderResult);
                        
                        console.log('âœ… æ¸¸æˆå¼•æ“åˆå§‹åŒ–å®Œæˆï¼');
                        
                    } catch (error) {
                        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                    }
                }
                
                // ğŸš€ å¯åŠ¨æ¸¸æˆ
                async function startGame() {
                    if (gameState.running) return;
                    
                    gameState.running = true;
                    {{#start-btn}}->textContent = 'â¸ï¸ æš‚åœæ¸¸æˆ';
                    
                    console.log('ğŸ® æ¸¸æˆå¯åŠ¨ï¼');
                    
                    // åˆ›å»ºç©å®¶
                    await {{spawnPlayer}}({
                        type: 'player',
                        position: gameState.playerPosition,
                        health: 100
                    });
                    
                    // å¯åŠ¨æ¸¸æˆå¾ªç¯
                    gameLoop = setInterval(async () => {
                        await updateGameFrame();
                    }, 16); // 60 FPS
                    
                    // æ’­æ”¾èƒŒæ™¯éŸ³ä¹
                    await {{playSound}}({
                        file: 'background.mp3',
                        volume: 0.5,
                        loop: true
                    });
                }
                
                // ğŸ”„ æ¸¸æˆå¸§æ›´æ–°
                async function updateGameFrame() {
                    try {
                        // âš¡ æ›´æ–°ç‰©ç†ç³»ç»Ÿï¼ˆä½¿ç”¨CJMODçš„é«˜æ€§èƒ½C++ç‰©ç†å¼•æ“ï¼‰
                        const physicsUpdate = await {{updatePhysics}}();
                        
                        // ğŸ’¥ ç¢°æ’æ£€æµ‹
                        const collisions = await {{checkCollisions}}();
                        
                        // ğŸ¨ æ¸²æŸ“å¸§
                        const renderData = await {{getRenderData}}();
                        
                        // æ›´æ–°UIæ˜¾ç¤º
                        updateGameUI(renderData);
                        
                        // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
                        if (gameState.score > 1000) {
                            levelUp();
                        }
                        
                    } catch (error) {
                        console.error('âŒ æ¸¸æˆæ›´æ–°å¤±è´¥:', error);
                    }
                }
                
                // ğŸ‘¹ ç”Ÿæˆæ•Œäºº
                async function spawnEnemy() {
                    try {
                        // ğŸš€ ä½¿ç”¨CJMODåˆ›é€ çš„spawnEnemyè¯­æ³•ï¼
                        const enemy = await {{spawnEnemy}}({
                            type: 'basic_enemy',
                            position: {
                                x: Math.random() * 800,
                                y: Math.random() * 600
                            },
                            health: 50,
                            speed: 2.0,
                            ai: 'aggressive'
                        });
                        
                        console.log('ğŸ‘¹ æ•Œäººå·²ç”Ÿæˆ:', enemy);
                        
                        // åˆ›å»ºè§†è§‰è¡¨ç¤º
                        createEnemyVisual(enemy);
                        
                        // æ’­æ”¾ç”ŸæˆéŸ³æ•ˆ
                        await {{playSound}}({
                            file: 'enemy_spawn.wav',
                            volume: 0.7,
                            loop: false
                        });
                        
                        gameState.enemies.push(enemy);
                        
                    } catch (error) {
                        console.error('âŒ ç”Ÿæˆæ•Œäººå¤±è´¥:', error);
                    }
                }
                
                // ğŸ¨ åˆ›å»ºæ•Œäººè§†è§‰æ•ˆæœ
                function createEnemyVisual(enemy) {
                    const canvas = {{#game-canvas}};
                    const enemyDiv = document.createElement('div');
                    enemyDiv->className = 'game-object enemy';
                    enemyDiv->id = 'enemy_' + enemy.id;
                    enemyDiv->style.left = enemy.position.x + 'px';
                    enemyDiv->style.top = enemy.position.y + 'px';
                    
                    canvas->appendChild(enemyDiv);
                    
                    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                    enemyDiv->animate([
                        { transform: 'scale(0)', opacity: 0 },
                        { transform: 'scale(1.2)', opacity: 1 },
                        { transform: 'scale(1)', opacity: 1 }
                    ], {
                        duration: 500,
                        easing: 'ease-out'
                    });
                }
                
                // ğŸ“Š æ›´æ–°æ¸¸æˆUI
                function updateGameUI(renderData) {
                    {{#score}}->textContent = 'åˆ†æ•°: ' + gameState.score;
                    {{#level}}->textContent = 'ç­‰çº§: ' + gameState.level;
                    {{#objects}}->textContent = 'å¯¹è±¡: ' + renderData.objects.length;
                    
                    // æ›´æ–°FPSæ˜¾ç¤º
                    const fps = Math.round(1000 / 16); // ç®€åŒ–è®¡ç®—
                    {{#fps}}->textContent = 'FPS: ' + fps;
                }
                
                // ğŸ†™ å‡çº§
                async function levelUp() {
                    gameState.level++;
                    gameState.score += 500;
                    
                    console.log('ğŸ†™ å‡çº§åˆ°ç­‰çº§', gameState.level);
                    
                    // æ’­æ”¾å‡çº§éŸ³æ•ˆ
                    await {{playSound}}({
                        file: 'levelup.wav',
                        volume: 0.8,
                        loop: false
                    });
                    
                    // ç”Ÿæˆæ›´å¤šæ•Œäºº
                    for (let i = 0; i < gameState.level; i++) {
                        setTimeout(() => spawnEnemy(), i * 1000);
                    }
                }
                
                // ğŸ’¾ ä¿å­˜æ¸¸æˆ
                async function saveGameState() {
                    try {
                        const saveData = {
                            score: gameState.score,
                            level: gameState.level,
                            playerPosition: gameState.playerPosition,
                            enemies: gameState.enemies.length,
                            timestamp: Date.now()
                        };
                        
                        // ğŸš€ ä½¿ç”¨CJMODåˆ›é€ çš„saveGameè¯­æ³•ï¼
                        await {{saveGame}}({
                            slot: 1,
                            data: saveData
                        });
                        
                        console.log('ğŸ’¾ æ¸¸æˆå·²ä¿å­˜!', saveData);
                        alert('æ¸¸æˆä¿å­˜æˆåŠŸï¼');
                        
                    } catch (error) {
                        console.error('âŒ ä¿å­˜å¤±è´¥:', error);
                        alert('ä¿å­˜å¤±è´¥: ' + error.message);
                    }
                }
                
                // ğŸµ éŸ³æ•ˆç®¡ç†
                async function playGameSound(soundType) {
                    const sounds = {
                        shoot: { file: 'shoot.wav', volume: 0.6 },
                        explosion: { file: 'explosion.wav', volume: 0.8 },
                        powerup: { file: 'powerup.wav', volume: 0.7 },
                        background: { file: 'bg_music.mp3', volume: 0.3, loop: true }
                    };
                    
                    if (sounds[soundType]) {
                        await {{playSound}}(sounds[soundType]);
                    }
                }
                
                // ğŸ¯ äº‹ä»¶ç›‘å¬
                {{#start-btn}}->addEventListener('click', async function() {
                    if (!gameState.running) {
                        await startGame();
                    } else {
                        // æš‚åœæ¸¸æˆ
                        gameState.running = false;
                        clearInterval(gameLoop);
                        this.textContent = 'ğŸš€ å¯åŠ¨æ¸¸æˆ';
                    }
                });
                
                {{#spawn-btn}}->addEventListener('click', spawnEnemy);
                
                {{#physics-btn}}->addEventListener('click', async function() {
                    const result = await {{updatePhysics}}();
                    console.log('âš¡ ç‰©ç†æ›´æ–°:', result);
                });
                
                {{#sound-btn}}->addEventListener('click', async function() {
                    await playGameSound('powerup');
                });
                
                {{#save-btn}}->addEventListener('click', saveGameState);
                
                // ğŸ® é”®ç›˜æ§åˆ¶
                document->addEventListener('keydown', async function(e) {
                    if (!gameState.running) return;
                    
                    switch(e.key) {
                        case 'ArrowUp':
                        case 'w':
                        case 'W':
                            gameState.playerPosition.y -= 10;
                            await playGameSound('shoot');
                            break;
                        case 'ArrowDown':
                        case 's':
                        case 'S':
                            gameState.playerPosition.y += 10;
                            break;
                        case 'ArrowLeft':
                        case 'a':
                        case 'A':
                            gameState.playerPosition.x -= 10;
                            break;
                        case 'ArrowRight':
                        case 'd':
                        case 'D':
                            gameState.playerPosition.x += 10;
                            break;
                        case ' ':
                            // ç©ºæ ¼é”®å°„å‡»
                            await spawnProjectile();
                            await playGameSound('shoot');
                            break;
                    }
                });
                
                // ğŸš€ å‘å°„å­å¼¹
                async function spawnProjectile() {
                    const projectile = await {{spawnProjectile}}({
                        type: 'player_bullet',
                        position: gameState.playerPosition,
                        velocity: {x: 0, y: -10},
                        damage: 25
                    });
                    
                    gameState.score += 10;
                }
                
                // ğŸ¯ åˆå§‹åŒ–æ¸¸æˆ
                async function initGame() {
                    console.log('ğŸ® åˆå§‹åŒ–CJMODæ¸¸æˆå¼•æ“...');
                    
                    await initGameEngine();
                    
                    // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
                    console.log('ğŸ‰ æ¸¸æˆå¼•æ“åˆå§‹åŒ–å®Œæˆï¼');
                    console.log('ğŸ® æ§åˆ¶è¯´æ˜:');
                    console.log('   WASD/æ–¹å‘é”® - ç§»åŠ¨');
                    console.log('   ç©ºæ ¼é”® - å°„å‡»');
                    console.log('   ç‚¹å‡»æŒ‰é’® - å„ç§åŠŸèƒ½');
                    
                    // é¢„åŠ è½½éŸ³æ•ˆ
                    await playGameSound('background');
                }
                
                // å¯åŠ¨æ¸¸æˆ
                initGame();
            }
        }
    }
}