// ========================================
// å®æ—¶èŠå¤©ç³»ç»Ÿä½¿ç”¨ç¤ºä¾‹
// å±•ç¤ºå¦‚ä½•åœ¨CHTL JSä¸­ä½¿ç”¨CJMODæ‰©å±•
// ========================================

html {
    head {
        title { text { å®æ—¶èŠå¤©ç³»ç»Ÿ - CJMODç¤ºä¾‹ } }
        
        style {
            .chat-container {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                font-family: Arial, sans-serif;
            }
            
            .chat-messages {
                height: 400px;
                border: 1px solid #ddd;
                overflow-y: auto;
                padding: 10px;
                margin-bottom: 10px;
                background: #f9f9f9;
            }
            
            .message {
                margin-bottom: 10px;
                padding: 8px;
                border-radius: 5px;
                background: white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .message.system {
                background: #e3f2fd;
                font-style: italic;
            }
            
            .chat-input {
                display: flex;
                gap: 10px;
            }
            
            .chat-input input {
                flex: 1;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            
            .chat-input button {
                padding: 10px 20px;
                background: #2196f3;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }
            
            .user-list {
                position: fixed;
                right: 20px;
                top: 20px;
                width: 200px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 5px;
                padding: 10px;
            }
            
            .stats-panel {
                background: #f5f5f5;
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 20px;
            }
        }
    }
    
    body {
        div {
            class: chat-container;
            
            h1 { text { ğŸš€ å®æ—¶èŠå¤©ç³»ç»Ÿ - CJMODå¼ºåŠ›é©±åŠ¨ } }
            
            // ç»Ÿè®¡é¢æ¿
            div {
                id: stats-panel;
                class: stats-panel;
                
                script {
                    // ä½¿ç”¨CJMODæ‰©å±•çš„èŠå¤©ç»Ÿè®¡åŠŸèƒ½
                    async function updateStats() {
                        const stats = await {{getChatStats}}();
                        {{#stats-panel}}->innerHTML = `
                            ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š
                            æ¶ˆæ¯æ€»æ•°: ${stats.totalMessages} | 
                            åœ¨çº¿ç”¨æˆ·: ${stats.onlineUsers} | 
                            èŠå¤©å®¤: ${stats.chatRooms} |
                            è¿è¡Œæ—¶é—´: ${Math.floor(stats.serverUptime / 60)}åˆ†é’Ÿ
                        `;
                    }
                    
                    // æ¯5ç§’æ›´æ–°ä¸€æ¬¡ç»Ÿè®¡
                    setInterval(updateStats, 5000);
                    updateStats();
                }
            }
            
            // èŠå¤©æ¶ˆæ¯åŒºåŸŸ
            div {
                id: chat-messages;
                class: chat-messages;
            }
            
            // èŠå¤©è¾“å…¥åŒºåŸŸ
            div {
                class: chat-input;
                
                input {
                    id: message-input;
                    type: text;
                    placeholder: è¾“å…¥æ¶ˆæ¯...æŒ‰Enterå‘é€;
                }
                
                button {
                    id: send-btn;
                    text { å‘é€ }
                }
                
                button {
                    id: emoji-btn;
                    text { ğŸ˜Š }
                }
                
                button {
                    id: encrypt-btn;
                    text { ğŸ”’ }
                }
            }
            
            script {
                // ========================================
                // ä½¿ç”¨CJMODåˆ›é€ çš„å…¨æ–°CHTL JSè¯­æ³•ï¼
                // ========================================
                
                let currentUserId = null;
                let encryptionEnabled = false;
                
                // è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨ - ä½¿ç”¨CJMODæ‰©å±•
                async function initializeChat() {
                    try {
                        // ğŸš€ ä½¿ç”¨CJMODçš„connectUseråŠŸèƒ½
                        const userInfo = await {{connectUser}}('{"nickname": "CHTLç”¨æˆ·"}');
                        currentUserId = userInfo.userId;
                        
                        console.log('âœ… è¿æ¥æˆåŠŸ:', userInfo);
                        
                        // åŠ è½½èŠå¤©å†å²
                        await loadChatHistory();
                        
                        // å¯åŠ¨å®æ—¶æ›´æ–°
                        startRealTimeUpdates();
                        
                    } catch (error) {
                        console.error('âŒ è¿æ¥å¤±è´¥:', error);
                    }
                }
                
                // å‘é€æ¶ˆæ¯ - æ”¯æŒåŠ å¯†å’Œæ™ºèƒ½è¿‡æ»¤
                async function sendChatMessage(content) {
                    try {
                        let messageContent = content;
                        
                        // ğŸ”’ å¦‚æœå¯ç”¨åŠ å¯†ï¼Œä½¿ç”¨CJMODåŠ å¯†åŠŸèƒ½
                        if (encryptionEnabled) {
                            const encrypted = await {{encryptMessage}}(content);
                            messageContent = encrypted.encrypted;
                            console.log('ğŸ”’ æ¶ˆæ¯å·²åŠ å¯†');
                        }
                        
                        // ğŸ›¡ï¸ æ™ºèƒ½æ¶ˆæ¯è¿‡æ»¤
                        const filtered = await {{filterMessage}}(messageContent);
                        
                        // ğŸ“¤ å‘é€æ¶ˆæ¯
                        const result = await {{sendMessage}}(filtered.filtered);
                        
                        if (result.error) {
                            throw new Error(result.error);
                        }
                        
                        console.log('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ:', result);
                        
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        {{#message-input}}->value = '';
                        
                        // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
                        await loadChatHistory();
                        
                    } catch (error) {
                        console.error('âŒ å‘é€å¤±è´¥:', error);
                        alert('å‘é€å¤±è´¥: ' + error.message);
                    }
                }
                
                // åŠ è½½èŠå¤©å†å²
                async function loadChatHistory() {
                    try {
                        // ğŸ“œ è·å–èŠå¤©å†å²
                        const history = await {{getChatHistory}}('general');
                        
                        const messagesDiv = {{#chat-messages}};
                        messagesDiv->innerHTML = '';
                        
                        history.messages->forEach(msg => {
                            const messageDiv = document.createElement('div');
                            messageDiv->className = 'message ' + msg.type;
                            
                            let displayContent = msg.content;
                            
                            // ğŸ”“ å¦‚æœæ˜¯åŠ å¯†æ¶ˆæ¯ï¼Œå°è¯•è§£å¯†
                            if (msg.type === 'encrypted') {
                                try {
                                    const decrypted = await {{decryptMessage}}(msg.content);
                                    displayContent = 'ğŸ”“ ' + decrypted.decrypted;
                                } catch (e) {
                                    displayContent = 'ğŸ”’ [åŠ å¯†æ¶ˆæ¯]';
                                }
                            }
                            
                            const timestamp = new Date(msg.timestamp)->toLocaleTimeString();
                            
                            messageDiv->innerHTML = `
                                <strong>${msg.userId}:</strong> 
                                ${displayContent}
                                <small style="color: #666; float: right;">${timestamp}</small>
                            `;
                            
                            messagesDiv->appendChild(messageDiv);
                        });
                        
                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        messagesDiv->scrollTop = messagesDiv->scrollHeight;
                        
                    } catch (error) {
                        console.error('âŒ åŠ è½½å†å²å¤±è´¥:', error);
                    }
                }
                
                // å®æ—¶æ›´æ–°
                function startRealTimeUpdates() {
                    setInterval(async () => {
                        await loadChatHistory();
                        await updateOnlineUsers();
                    }, 2000); // æ¯2ç§’æ›´æ–°
                }
                
                // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
                async function updateOnlineUsers() {
                    try {
                        // ğŸ‘¥ è·å–åœ¨çº¿ç”¨æˆ·
                        const users = await {{getOnlineUsers}}();
                        
                        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨UIï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        const userListDiv = document.getElementById('user-list');
                        if (userListDiv) {
                            userListDiv->innerHTML = '<h3>åœ¨çº¿ç”¨æˆ· (' + users.count + ')</h3>';
                            users.users->forEach(user => {
                                userListDiv->innerHTML += `<div>ğŸ‘¤ ${user.nickname}</div>`;
                            });
                        }
                        
                    } catch (error) {
                        console.error('âŒ æ›´æ–°ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                    }
                }
                
                // ğŸ¤– èŠå¤©æœºå™¨äººäº’åŠ¨
                async function askChatBot(question) {
                    try {
                        const response = await {{chatBot}}(question);
                        
                        // æ˜¾ç¤ºæœºå™¨äººå›å¤
                        const messagesDiv = {{#chat-messages}};
                        const botDiv = document.createElement('div');
                        botDiv->className = 'message system';
                        botDiv->innerHTML = `<strong>ğŸ¤– èŠå¤©åŠ©æ‰‹:</strong> ${response.botReply}`;
                        messagesDiv->appendChild(botDiv);
                        messagesDiv->scrollTop = messagesDiv->scrollHeight;
                        
                    } catch (error) {
                        console.error('âŒ æœºå™¨äººå›å¤å¤±è´¥:', error);
                    }
                }
                
                // äº‹ä»¶ç›‘å¬
                {{#message-input}}->addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && this.value.trim()) {
                        sendChatMessage(this.value.trim());
                    }
                });
                
                {{#send-btn}}->addEventListener('click', function() {
                    const input = {{#message-input}};
                    if (input->value.trim()) {
                        sendChatMessage(input->value.trim());
                    }
                });
                
                {{#emoji-btn}}->addEventListener('click', function() {
                    const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'â¤ï¸', 'ğŸ‘', 'ğŸ‰', 'ğŸ”¥', 'ğŸ’¯'];
                    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                    {{#message-input}}->value += randomEmoji;
                });
                
                {{#encrypt-btn}}->addEventListener('click', function() {
                    encryptionEnabled = !encryptionEnabled;
                    this.textContent = encryptionEnabled ? 'ğŸ”’ å·²å¯ç”¨' : 'ğŸ”’ åŠ å¯†';
                    this.style.background = encryptionEnabled ? '#4caf50' : '#2196f3';
                });
                
                // åˆå§‹åŒ–èŠå¤©ç³»ç»Ÿ
                initializeChat();
                
                // æ·»åŠ ä¸€äº›æµ‹è¯•å‘½ä»¤
                window.testCommands = {
                    '/bot': (msg) => askChatBot(msg.replace('/bot ', '')),
                    '/stats': () => {{getChatStats}}(),
                    '/users': () => {{getOnlineUsers}}(),
                    '/room': () => {{createPrivateRoom}}('{}'),
                    '/encrypt': (msg) => {{encryptMessage}}(msg.replace('/encrypt ', ''))
                };
                
                console.log('ğŸ‰ å®æ—¶èŠå¤©ç³»ç»Ÿå·²å¯åŠ¨ï¼');
                console.log('ğŸ’¡ å¯ç”¨å‘½ä»¤:', Object.keys(window.testCommands));
            }
        }
        
        // åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        div {
            id: user-list;
            class: user-list;
            
            h3 { text { åœ¨çº¿ç”¨æˆ· } }
            div { text { åŠ è½½ä¸­... } }
        }
    }
}