// ========================================
// ğŸ§® ç®€å•è®¡ç®—å™¨ - CHTL JSè½¬JavaScriptç¤ºä¾‹
// å±•ç¤ºCHTL JSå¦‚ä½•è½¬æ¢æˆæ ‡å‡†JavaScriptä»£ç 
// ========================================

html {
    head {
        title { text { ğŸ§® CHTL JSè®¡ç®—å™¨æ¼”ç¤º } }
        
        style {
            body {
                margin: 0;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                font-family: 'Arial', sans-serif;
                min-height: 100vh;
            }
            
            .calculator {
                max-width: 400px;
                margin: 0 auto;
                background: white;
                border-radius: 20px;
                padding: 30px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            }
            
            .display {
                width: 100%;
                height: 80px;
                font-size: 24px;
                text-align: right;
                padding: 15px;
                border: 2px solid #667eea;
                border-radius: 10px;
                margin-bottom: 20px;
                background: #f8f9fa;
            }
            
            .buttons {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }
            
            .btn {
                height: 60px;
                border: none;
                border-radius: 10px;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .btn.number {
                background: #e3f2fd;
                color: #1976d2;
            }
            
            .btn.operator {
                background: #667eea;
                color: white;
            }
            
            .btn.equals {
                background: #4caf50;
                color: white;
                grid-column: span 2;
            }
            
            .btn.clear {
                background: #f44336;
                color: white;
            }
            
            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }
            
            .history {
                margin-top: 20px;
                padding: 15px;
                background: #f5f5f5;
                border-radius: 10px;
                max-height: 200px;
                overflow-y: auto;
            }
        }
    }
    
    body {
        div {
            class: calculator;
            
            h1 { 
                text { ğŸ§® CHTL JSè®¡ç®—å™¨ }
                style { text-align: center; color: #667eea; margin-bottom: 30px; }
            }
            
            // æ˜¾ç¤ºå±
            input {
                id: display;
                class: display;
                type: text;
                readonly: true;
                value: 0;
            }
            
            // æŒ‰é’®åŒºåŸŸ
            div {
                class: buttons;
                
                // æ¸…é™¤æŒ‰é’®
                button { id: clear; class: btn clear; text { C } }
                button { id: backspace; class: btn operator; text { âŒ« } }
                button { id: percent; class: btn operator; text { % } }
                button { id: divide; class: btn operator; text { Ã· } }
                
                // æ•°å­—æŒ‰é’® 7-9
                button { id: seven; class: btn number; text { 7 } }
                button { id: eight; class: btn number; text { 8 } }
                button { id: nine; class: btn number; text { 9 } }
                button { id: multiply; class: btn operator; text { Ã— } }
                
                // æ•°å­—æŒ‰é’® 4-6
                button { id: four; class: btn number; text { 4 } }
                button { id: five; class: btn number; text { 5 } }
                button { id: six; class: btn number; text { 6 } }
                button { id: subtract; class: btn operator; text { - } }
                
                // æ•°å­—æŒ‰é’® 1-3
                button { id: one; class: btn number; text { 1 } }
                button { id: two; class: btn number; text { 2 } }
                button { id: three; class: btn number; text { 3 } }
                button { id: add; class: btn operator; text { + } }
                
                // åº•éƒ¨æŒ‰é’®
                button { id: zero; class: btn number; text { 0 } }
                button { id: decimal; class: btn number; text { . } }
                button { id: equals; class: btn equals; text { = } }
            }
            
            // è®¡ç®—å†å²
            div {
                id: history;
                class: history;
                
                h3 { text { ğŸ“Š è®¡ç®—å†å² } }
                div { id: history-list; text { æš‚æ— è®¡ç®—è®°å½• } }
            }
            
            script {
                // ========================================
                // ğŸš€ CHTL JSä»£ç  - å°†è½¬æ¢æˆæ ‡å‡†JavaScript
                // ========================================
                
                // è®¡ç®—å™¨çŠ¶æ€
                vir calculator = {
                    currentValue: 0,
                    previousValue: 0,
                    operator: null,
                    waitingForOperand: false,
                    history: []
                };
                
                // ğŸ¯ CHTL JSå¢å¼ºé€‰æ‹©å™¨ - è½¬æ¢æˆdocument.querySelector
                const display = {{#display}};              // â†’ document.getElementById('display')
                const historyList = {{#history-list}};     // â†’ document.getElementById('history-list')
                
                // ğŸ”¢ è¾“å…¥æ•°å­— - CHTL JSå‡½æ•°è½¬æ¢æˆæ™®é€šå‡½æ•°
                function inputNumber(num) {
                    if (calculator->waitingForOperand) {
                        display->value = String(num);
                        calculator->waitingForOperand = false;
                    } else {
                        display->value = display->value === '0' ? String(num) : display->value + num;
                    }
                    calculator->currentValue = parseFloat(display->value);
                }
                
                // â• è¾“å…¥æ“ä½œç¬¦
                function inputOperator(nextOperator) {
                    const inputValue = parseFloat(display->value);
                    
                    if (calculator->previousValue === null) {
                        calculator->previousValue = inputValue;
                    } else if (calculator->operator) {
                        const currentValue = calculator->currentValue || 0;
                        const newValue = performCalculation();
                        
                        display->value = String(newValue);
                        calculator->currentValue = newValue;
                        calculator->previousValue = newValue;
                    }
                    
                    calculator->waitingForOperand = true;
                    calculator->operator = nextOperator;
                }
                
                // ğŸ§® æ‰§è¡Œè®¡ç®—
                function performCalculation() {
                    const prev = calculator->previousValue;
                    const current = calculator->currentValue;
                    const operator = calculator->operator;
                    
                    if (prev === null || current === null || !operator) {
                        return current;
                    }
                    
                    let result;
                    switch (operator) {
                        case '+': result = prev + current; break;
                        case '-': result = prev - current; break;
                        case 'Ã—': result = prev * current; break;
                        case 'Ã·': result = current !== 0 ? prev / current : 0; break;
                        case '%': result = prev % current; break;
                        default: return current;
                    }
                    
                    // ğŸ“Š æ·»åŠ åˆ°å†å²è®°å½•
                    const historyEntry = `${prev} ${operator} ${current} = ${result}`;
                    calculator->history.push(historyEntry);
                    updateHistory();
                    
                    return result;
                }
                
                // ğŸ“Š æ›´æ–°å†å²æ˜¾ç¤º
                function updateHistory() {
                    if (calculator->history.length === 0) {
                        historyList->innerHTML = 'æš‚æ— è®¡ç®—è®°å½•';
                        return;
                    }
                    
                    let historyHTML = '';
                    // æ˜¾ç¤ºæœ€è¿‘5æ¡è®°å½•
                    const recentHistory = calculator->history.slice(-5);
                    recentHistory->forEach((entry, index) => {
                        historyHTML += `<div style="padding: 5px; ${index === recentHistory.length - 1 ? 'font-weight: bold; color: #667eea;' : ''}">${entry}</div>`;
                    });
                    
                    historyList->innerHTML = historyHTML;
                }
                
                // ğŸ”„ é‡ç½®è®¡ç®—å™¨
                function resetCalculator() {
                    calculator->currentValue = 0;
                    calculator->previousValue = null;
                    calculator->operator = null;
                    calculator->waitingForOperand = false;
                    display->value = '0';
                }
                
                // âŒ« é€€æ ¼
                function backspace() {
                    const currentDisplay = display->value;
                    if (currentDisplay.length > 1) {
                        display->value = currentDisplay.slice(0, -1);
                    } else {
                        display->value = '0';
                    }
                    calculator->currentValue = parseFloat(display->value);
                }
                
                // ğŸ¯ CHTL JSäº‹ä»¶ç›‘å¬ - è½¬æ¢æˆaddEventListener
                
                // æ•°å­—æŒ‰é’®äº‹ä»¶
                {{.number}}->listen({
                    click: function() {
                        const num = this.textContent;
                        inputNumber(num);
                    }
                });
                
                // æ“ä½œç¬¦æŒ‰é’®äº‹ä»¶  
                {{#add}}->listen({ click: () => inputOperator('+') });
                {{#subtract}}->listen({ click: () => inputOperator('-') });
                {{#multiply}}->listen({ click: () => inputOperator('Ã—') });
                {{#divide}}->listen({ click: () => inputOperator('Ã·') });
                {{#percent}}->listen({ click: () => inputOperator('%') });
                
                // ç‰¹æ®ŠæŒ‰é’®äº‹ä»¶
                {{#equals}}->listen({
                    click: function() {
                        const result = performCalculation();
                        display->value = String(result);
                        calculator->currentValue = result;
                        calculator->previousValue = null;
                        calculator->operator = null;
                        calculator->waitingForOperand = true;
                    }
                });
                
                {{#clear}}->listen({ click: resetCalculator });
                {{#backspace}}->listen({ click: backspace });
                
                {{#decimal}}->listen({
                    click: function() {
                        if (display->value.indexOf('.') === -1) {
                            inputNumber('.');
                        }
                    }
                });
                
                // ğŸ¹ é”®ç›˜æ”¯æŒ
                document->listen({
                    keydown: function(e) {
                        e->preventDefault();
                        
                        if (e.key >= '0' && e.key <= '9') {
                            inputNumber(e.key);
                        } else if (['+', '-', '*', '/', '%'].includes(e.key)) {
                            const operatorMap = {'+': '+', '-': '-', '*': 'Ã—', '/': 'Ã·', '%': '%'};
                            inputOperator(operatorMap[e.key]);
                        } else if (e.key === 'Enter' || e.key === '=') {
                            {{#equals}}->click();
                        } else if (e.key === 'Escape' || e.key === 'c' || e.key === 'C') {
                            resetCalculator();
                        } else if (e.key === 'Backspace') {
                            backspace();
                        } else if (e.key === '.') {
                            {{#decimal}}->click();
                        }
                    }
                });
                
                // ğŸ¨ åˆå§‹åŒ–åŠ¨ç”»
                animate({
                    target: {{.calculator}},
                    duration: 800,
                    begin: { opacity: 0, transform: 'scale(0.8) translateY(50px)' },
                    end: { opacity: 1, transform: 'scale(1) translateY(0px)' },
                    easing: 'ease-out'
                });
                
                // ğŸµ æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆï¼ˆæ¨¡æ‹Ÿï¼‰
                {{.btn}}->delegate({
                    click: function() {
                        // ç®€å•çš„ç‚¹å‡»åé¦ˆ
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.style.transform = '';
                        }, 100);
                        
                        // æ¨¡æ‹ŸæŒ‰é”®éŸ³æ•ˆ
                        console.log('ğŸ”Š æŒ‰é”®éŸ³æ•ˆ: ' + this.textContent);
                    }
                });
                
                console.log('ğŸ§® CHTL JSè®¡ç®—å™¨å·²å¯åŠ¨ï¼');
                console.log('ğŸ¹ æ”¯æŒé”®ç›˜è¾“å…¥ï¼šæ•°å­—ã€è¿ç®—ç¬¦ã€Enterã€Escapeã€Backspace');
            }
        }
    }
}