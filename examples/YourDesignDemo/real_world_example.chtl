// ========================================
// çœŸå®ä¸–ç•Œçš„CJMODä½¿ç”¨ç¤ºä¾‹
// å±•ç¤ºå¤æ‚å‚æ•°å¤„ç†çš„å®é™…åº”ç”¨
// ========================================

// ğŸ¯ ç¤ºä¾‹1ï¼šé«˜çº§åŠ¨ç”»ç³»ç»Ÿ - åŒ…å«å‡½æ•°å‚æ•°
animate({
    element: '#hero-section',
    duration: '2.5s',
    easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
    keyframes: [
        { offset: 0, transform: 'translateY(-50px)', opacity: 0 },
        { offset: 0.5, transform: 'translateY(-10px)', opacity: 0.7 },
        { offset: 1, transform: 'translateY(0)', opacity: 1 }
    ],
    onStart: function() {
        console.log('ğŸ¬ åŠ¨ç”»å¼€å§‹');
        this.classList.add('animating');
    },
    onProgress: function(progress, currentFrame) {
        // å¤æ‚çš„è¿›åº¦å¤„ç†å‡½æ•°
        const percentage = Math.floor(progress * 100);
        document.querySelector('#progress-bar').style.width = percentage + '%';
        
        if (progress > 0.5) {
            this.style.boxShadow = `0 ${progress * 20}px ${progress * 40}px rgba(0,0,0,${progress * 0.3})`;
        }
    },
    onComplete: function() {
        console.log('âœ… åŠ¨ç”»å®Œæˆ');
        this.classList.remove('animating');
        this.classList.add('animated');
        
        // è§¦å‘åç»­åŠ¨ç”»
        setTimeout(() => {
            this.nextElementSibling?.animate?.call(this, {
                duration: '1s',
                easing: 'ease-out'
            });
        }, 200);
    }
});

// ğŸ¯ ç¤ºä¾‹2ï¼šæ•°æ®å¤„ç†ç®¡é“ - åŒ…å«å¤æ‚å¯¹è±¡å’Œå‡½æ•°
processData({
    source: {
        url: 'https://api.example.com/data',
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: {
            query: 'SELECT * FROM users WHERE active = true',
            limit: 100,
            offset: 0
        }
    },
    transformers: [
        function(data) {
            // æ•°æ®æ¸…æ´—
            return data.filter(item => item.id && item.name)
                      .map(item => ({
                          ...item,
                          name: item.name.trim(),
                          email: item.email?.toLowerCase()
                      }));
        },
        function(data) {
            // æ•°æ®åˆ†ç»„
            const grouped = {};
            data.forEach(item => {
                const category = item.category || 'uncategorized';
                if (!grouped[category]) {
                    grouped[category] = [];
                }
                grouped[category].push(item);
            });
            return grouped;
        },
        function(data) {
            // æ•°æ®æ’åº
            Object.keys(data).forEach(category => {
                data[category].sort((a, b) => {
                    return new Date(b.created_at) - new Date(a.created_at);
                });
            });
            return data;
        }
    ],
    validators: {
        schema: {
            id: 'number',
            name: 'string',
            email: 'string',
            created_at: 'date'
        },
        customRules: [
            function(item) {
                return item.name.length >= 2 && item.name.length <= 50;
            },
            function(item) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return !item.email || emailRegex.test(item.email);
            }
        ]
    },
    onSuccess: function(processedData, originalData, stats) {
        console.log('ğŸ‰ æ•°æ®å¤„ç†æˆåŠŸ');
        console.log('ğŸ“Š å¤„ç†ç»Ÿè®¡:', stats);
        console.log('ğŸ“¦ å¤„ç†ç»“æœ:', processedData);
        
        // æ›´æ–°UI
        updateDataTable(processedData);
        updateStatistics(stats);
        
        // ç¼“å­˜ç»“æœ
        localStorage.setItem('processedData', JSON.stringify({
            data: processedData,
            timestamp: Date.now(),
            stats: stats
        }));
    },
    onError: function(error, stage, partialData) {
        console.error('âŒ æ•°æ®å¤„ç†å¤±è´¥:', error);
        console.log('ğŸ“ å¤±è´¥é˜¶æ®µ:', stage);
        
        if (partialData) {
            console.log('âš ï¸ éƒ¨åˆ†æ•°æ®:', partialData);
            // å°è¯•ä½¿ç”¨éƒ¨åˆ†æ•°æ®
            this.onSuccess(partialData, null, { partial: true });
        } else {
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            showErrorMessage('æ•°æ®å¤„ç†å¤±è´¥: ' + error.message);
        }
    }
});

// ğŸ¯ ç¤ºä¾‹3ï¼šç»„ä»¶ç³»ç»Ÿ - å¤æ‚åµŒå¥—ç»“æ„
createComponent({
    name: 'UserProfile',
    props: {
        userId: Number,
        showAvatar: Boolean,
        theme: String,
        permissions: Array
    },
    data: function() {
        return {
            user: null,
            loading: true,
            error: null,
            avatar: null
        };
    },
    computed: {
        displayName: function() {
            if (!this.user) return 'åŠ è½½ä¸­...';
            return this.user.firstName + ' ' + this.user.lastName;
        },
        avatarUrl: function() {
            if (this.avatar) return this.avatar;
            if (this.user?.avatar) return this.user.avatar;
            return '/default-avatar.png';
        },
        hasPermission: function() {
            return (permission) => {
                return this.permissions.includes(permission) || 
                       this.permissions.includes('admin');
            };
        }
    },
    methods: {
        async loadUser() {
            try {
                this.loading = true;
                this.error = null;
                
                const response = await fetch(`/api/users/${this.userId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                this.user = await response.json();
                
                // åŠ è½½å¤´åƒ
                if (this.showAvatar && this.user.avatarId) {
                    await this.loadAvatar(this.user.avatarId);
                }
                
            } catch (error) {
                this.error = error.message;
                console.error('ç”¨æˆ·åŠ è½½å¤±è´¥:', error);
            } finally {
                this.loading = false;
            }
        },
        
        async loadAvatar(avatarId) {
            try {
                const response = await fetch(`/api/avatars/${avatarId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    this.avatar = URL.createObjectURL(blob);
                }
            } catch (error) {
                console.warn('å¤´åƒåŠ è½½å¤±è´¥:', error);
            }
        },
        
        updateProfile: function(updates) {
            const updatedUser = { ...this.user, ...updates };
            
            // éªŒè¯æ›´æ–°
            if (updates.email && !this.isValidEmail(updates.email)) {
                throw new Error('é‚®ç®±æ ¼å¼æ— æ•ˆ');
            }
            
            // å‘é€æ›´æ–°è¯·æ±‚
            return fetch(`/api/users/${this.userId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            }).then(response => {
                if (response.ok) {
                    this.user = updatedUser;
                    this.$emit('profile-updated', updatedUser);
                }
                return response;
            });
        },
        
        isValidEmail: function(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }
    },
    lifecycle: {
        created: function() {
            console.log('ğŸ¯ UserProfile ç»„ä»¶åˆ›å»º');
            this.loadUser();
        },
        
        mounted: function() {
            console.log('ğŸ¯ UserProfile ç»„ä»¶æŒ‚è½½');
            
            // ç›‘å¬ä¸»é¢˜å˜åŒ–
            this.$watch('theme', (newTheme) => {
                document.documentElement.setAttribute('data-theme', newTheme);
            });
        },
        
        updated: function() {
            console.log('ğŸ¯ UserProfile ç»„ä»¶æ›´æ–°');
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            if (this.user) {
                document.title = `${this.displayName} - ç”¨æˆ·èµ„æ–™`;
            }
        },
        
        destroyed: function() {
            console.log('ğŸ¯ UserProfile ç»„ä»¶é”€æ¯');
            
            // æ¸…ç†èµ„æº
            if (this.avatar && this.avatar.startsWith('blob:')) {
                URL.revokeObjectURL(this.avatar);
            }
        }
    }
});

// ğŸ¯ ç¤ºä¾‹4ï¼šé«˜çº§è¡¨å•å¤„ç† - åŒ…å«éªŒè¯å’Œè½¬æ¢
createForm({
    name: 'AdvancedContactForm',
    fields: {
        name: {
            type: 'text',
            required: true,
            validators: [
                function(value) {
                    return value.length >= 2 ? null : 'å§“åè‡³å°‘2ä¸ªå­—ç¬¦';
                },
                function(value) {
                    return /^[a-zA-Z\u4e00-\u9fa5\s]+$/.test(value) ? null : 'å§“ååªèƒ½åŒ…å«å­—æ¯ã€æ±‰å­—å’Œç©ºæ ¼';
                }
            ],
            transformers: [
                function(value) { return value.trim(); },
                function(value) { return value.replace(/\s+/g, ' '); }
            ]
        },
        email: {
            type: 'email',
            required: true,
            validators: [
                function(value) {
                    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return regex.test(value) ? null : 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
                }
            ],
            transformers: [
                function(value) { return value.toLowerCase().trim(); }
            ]
        },
        phone: {
            type: 'tel',
            required: false,
            validators: [
                function(value) {
                    if (!value) return null;
                    const regex = /^1[3-9]\d{9}$/;
                    return regex.test(value) ? null : 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç ';
                }
            ],
            transformers: [
                function(value) { return value.replace(/\D/g, ''); }
            ]
        }
    },
    onSubmit: function(formData, form) {
        console.log('ğŸ“ è¡¨å•æäº¤:', formData);
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        form.setLoading(true);
        
        // æäº¤æ•°æ®
        return fetch('/api/contact', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        }).then(response => {
            if (response.ok) {
                form.showSuccess('æäº¤æˆåŠŸï¼æˆ‘ä»¬ä¼šå°½å¿«è”ç³»æ‚¨ã€‚');
                form.reset();
            } else {
                throw new Error('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }).catch(error => {
            form.showError(error.message);
        }).finally(() => {
            form.setLoading(false);
        });
    },
    onValidate: function(field, value, allValues) {
        // è·¨å­—æ®µéªŒè¯
        if (field === 'email' && allValues.name) {
            // æ£€æŸ¥é‚®ç®±åŸŸåæ˜¯å¦ä¸å§“ååŒ¹é…ï¼ˆç¤ºä¾‹é€»è¾‘ï¼‰
            const domain = value.split('@')[1];
            if (domain === 'example.com' && !allValues.name.includes('Example')) {
                return 'é‚®ç®±åŸŸåä¸å§“åä¸åŒ¹é…';
            }
        }
        
        return null;
    }
});