#include <iostream>
#include <cassert>
#include <memory>
#include "CHTL/Selector/SelectorAutomation.h"
#include "CHTL/AST/CHTLASTNodes.h"
#include "CHTL/Core/CHTLToken.h"

using namespace CHTL;
using namespace CHTL::Selector;

// æµ‹è¯•é€‰æ‹©å™¨è‡ªåŠ¨åŒ–é…ç½®
void test_selector_automation_config() {
    std::cout << "æµ‹è¯•é€‰æ‹©å™¨è‡ªåŠ¨åŒ–é…ç½®...\n";
    
    SelectorAutomationConfig config;
    
    // æµ‹è¯•é»˜è®¤é…ç½®
    assert(!config.disableStyleAutoAddClass);   // é»˜è®¤å¯ç”¨æ ·å¼å—ç±»è‡ªåŠ¨åŒ–
    assert(!config.disableStyleAutoAddId);      // é»˜è®¤å¯ç”¨æ ·å¼å—IDè‡ªåŠ¨åŒ–
    assert(config.disableScriptAutoAddClass);   // é»˜è®¤ç¦ç”¨è„šæœ¬å—ç±»è‡ªåŠ¨åŒ–
    assert(config.disableScriptAutoAddId);      // é»˜è®¤ç¦ç”¨è„šæœ¬å—IDè‡ªåŠ¨åŒ–
    
    std::cout << "  é»˜è®¤é…ç½®éªŒè¯:\n";
    std::cout << "    æ ·å¼å—ç±»è‡ªåŠ¨åŒ–: " << (!config.disableStyleAutoAddClass ? "å¯ç”¨" : "ç¦ç”¨") << "\n";
    std::cout << "    æ ·å¼å—IDè‡ªåŠ¨åŒ–: " << (!config.disableStyleAutoAddId ? "å¯ç”¨" : "ç¦ç”¨") << "\n";
    std::cout << "    è„šæœ¬å—ç±»è‡ªåŠ¨åŒ–: " << (!config.disableScriptAutoAddClass ? "å¯ç”¨" : "ç¦ç”¨") << "\n";
    std::cout << "    è„šæœ¬å—IDè‡ªåŠ¨åŒ–: " << (!config.disableScriptAutoAddId ? "å¯ç”¨" : "ç¦ç”¨") << "\n";
    
    std::cout << "  âœ… é€‰æ‹©å™¨è‡ªåŠ¨åŒ–é…ç½®æµ‹è¯•é€šè¿‡\n";
}

// æµ‹è¯•é€‰æ‹©å™¨ç±»å‹æšä¸¾
void test_selector_types() {
    std::cout << "æµ‹è¯•é€‰æ‹©å™¨ç±»å‹æšä¸¾...\n";
    
    // æµ‹è¯•é€‰æ‹©å™¨ä¿¡æ¯åˆ›å»º
    SelectorInfo classInfo;
    classInfo.type = SelectorType::CLASS;
    classInfo.name = "button";
    classInfo.fullSelector = ".button";
    classInfo.position = 0;
    classInfo.isAutoGenerated = false;
    
    assert(classInfo.type == SelectorType::CLASS);
    assert(classInfo.name == "button");
    assert(classInfo.fullSelector == ".button");
    assert(!classInfo.isAutoGenerated);
    
    SelectorInfo enhancedInfo;
    enhancedInfo.type = SelectorType::ENHANCED_CLASS;
    enhancedInfo.name = "modal";
    enhancedInfo.fullSelector = "{{.modal}}";
    enhancedInfo.position = 0;
    enhancedInfo.isAutoGenerated = true;
    
    assert(enhancedInfo.type == SelectorType::ENHANCED_CLASS);
    assert(enhancedInfo.name == "modal");
    assert(enhancedInfo.fullSelector == "{{.modal}}");
    assert(enhancedInfo.isAutoGenerated);
    
    SelectorInfo refInfo;
    refInfo.type = SelectorType::REFERENCE;
    refInfo.name = "&";
    refInfo.fullSelector = "&";
    refInfo.position = 0;
    refInfo.isAutoGenerated = false;
    
    assert(refInfo.type == SelectorType::REFERENCE);
    assert(refInfo.name == "&");
    assert(refInfo.fullSelector == "&");
    
    std::cout << "  é€‰æ‹©å™¨ä¿¡æ¯ç»“æ„éªŒè¯:\n";
    std::cout << "    ç±»é€‰æ‹©å™¨: " << classInfo.fullSelector << " -> " << classInfo.name << "\n";
    std::cout << "    å¢å¼ºé€‰æ‹©å™¨: " << enhancedInfo.fullSelector << " -> " << enhancedInfo.name << "\n";
    std::cout << "    å¼•ç”¨é€‰æ‹©å™¨: " << refInfo.fullSelector << " -> " << refInfo.name << "\n";
    
    std::cout << "  âœ… é€‰æ‹©å™¨ç±»å‹æµ‹è¯•é€šè¿‡\n";
}

// æµ‹è¯•é€‰æ‹©å™¨è‡ªåŠ¨åŒ–ç®¡ç†å™¨åˆ›å»º
void test_selector_automation_manager_creation() {
    std::cout << "æµ‹è¯•é€‰æ‹©å™¨è‡ªåŠ¨åŒ–ç®¡ç†å™¨åˆ›å»º...\n";
    
    SelectorAutomationManager manager;
    
    // æµ‹è¯•é…ç½®è®¾ç½®
    SelectorAutomationConfig config;
    config.disableStyleAutoAddClass = true;
    config.disableStyleAutoAddId = false;
    config.disableScriptAutoAddClass = false;
    config.disableScriptAutoAddId = true;
    
    manager.SetConfig(config);
    
    // æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯
    std::string stats = manager.GetStatistics();
    assert(!stats.empty());
    
    std::cout << "  åˆå§‹ç»Ÿè®¡ä¿¡æ¯:\n" << stats;
    
    // æµ‹è¯•é‡ç½®ç»Ÿè®¡
    manager.ResetStatistics();
    std::string resetStats = manager.GetStatistics();
    assert(resetStats.find("0") != std::string::npos); // åº”è¯¥åŒ…å«0çš„ç»Ÿè®¡
    
    std::cout << "  é‡ç½®åç»Ÿè®¡ä¿¡æ¯:\n" << resetStats;
    
    std::cout << "  âœ… é€‰æ‹©å™¨è‡ªåŠ¨åŒ–ç®¡ç†å™¨åˆ›å»ºæµ‹è¯•é€šè¿‡\n";
}

// æµ‹è¯•åŸºæœ¬çš„å…ƒç´ å±æ€§æ“ä½œ
void test_basic_element_attributes() {
    std::cout << "æµ‹è¯•åŸºæœ¬çš„å…ƒç´ å±æ€§æ“ä½œ...\n";
    
    // åˆ›å»ºæµ‹è¯•å…ƒç´ 
    auto element = std::make_shared<AST::ElementNode>("div", Core::CHTLToken());
    
    // æµ‹è¯•åˆå§‹çŠ¶æ€
    assert(!element->HasAttribute("class"));
    assert(!element->HasAttribute("id"));
    
    // æ·»åŠ å±æ€§
    element->AddAttribute("class", "test-class");
    element->AddAttribute("id", "test-id");
    
    // éªŒè¯å±æ€§å·²æ·»åŠ 
    assert(element->HasAttribute("class"));
    assert(element->HasAttribute("id"));
    assert(element->GetAttribute("class") == "test-class");
    assert(element->GetAttribute("id") == "test-id");
    
    std::cout << "  å…ƒç´ å±æ€§æ“ä½œéªŒè¯:\n";
    std::cout << "    æ·»åŠ çš„class: " << element->GetAttribute("class") << "\n";
    std::cout << "    æ·»åŠ çš„id: " << element->GetAttribute("id") << "\n";
    
    // æµ‹è¯•å±æ€§é›†åˆ
    const auto& attributes = element->GetAttributes();
    assert(attributes.size() == 2);
    assert(attributes.at("class") == "test-class");
    assert(attributes.at("id") == "test-id");
    
    std::cout << "    å±æ€§é›†åˆå¤§å°: " << attributes.size() << "\n";
    
    std::cout << "  âœ… åŸºæœ¬å…ƒç´ å±æ€§æ“ä½œæµ‹è¯•é€šè¿‡\n";
}

int main() {
    std::cout << "è¿è¡Œé€‰æ‹©å™¨è‡ªåŠ¨åŒ–åŸºç¡€æµ‹è¯•...\n\n";
    
    try {
        test_selector_automation_config();
        test_selector_types();
        test_selector_automation_manager_creation();
        test_basic_element_attributes();
        
        std::cout << "\nğŸ‰ æ‰€æœ‰é€‰æ‹©å™¨è‡ªåŠ¨åŒ–åŸºç¡€æµ‹è¯•é€šè¿‡!\n";
        std::cout << "âœ… é€‰æ‹©å™¨è‡ªåŠ¨åŒ–é…ç½®æ­£å¸¸\n";
        std::cout << "âœ… é€‰æ‹©å™¨ç±»å‹ç³»ç»Ÿæ­£å¸¸\n";
        std::cout << "âœ… é€‰æ‹©å™¨è‡ªåŠ¨åŒ–ç®¡ç†å™¨åˆ›å»ºæ­£å¸¸\n";
        std::cout << "âœ… åŸºæœ¬å…ƒç´ å±æ€§æ“ä½œæ­£å¸¸\n";
        
        std::cout << "\nğŸ“‹ é€‰æ‹©å™¨è‡ªåŠ¨åŒ–åŠŸèƒ½æ€»ç»“:\n";
        std::cout << "ğŸ”§ [Configuration]é…ç½®æ”¯æŒ:\n";
        std::cout << "   DISABLE_STYLE_AUTO_ADD_CLASS = false (é»˜è®¤å¯ç”¨)\n";
        std::cout << "   DISABLE_STYLE_AUTO_ADD_ID = false (é»˜è®¤å¯ç”¨)\n";
        std::cout << "   DISABLE_SCRIPT_AUTO_ADD_CLASS = true (é»˜è®¤ç¦ç”¨ï¼Œå¯ç”¨ç‰¹æ®Šé€»è¾‘)\n";
        std::cout << "   DISABLE_SCRIPT_AUTO_ADD_ID = true (é»˜è®¤ç¦ç”¨ï¼Œå¯ç”¨ç‰¹æ®Šé€»è¾‘)\n";
        std::cout << "\nğŸ¯ è‡ªåŠ¨åŒ–è§„åˆ™:\n";
        std::cout << "   å±€éƒ¨æ ·å¼å—ï¼šclass/idå±æ€§ç¼ºå¤±æ—¶è‡ªåŠ¨æ·»åŠ ç¬¬ä¸€ä¸ªé€‰æ‹©å™¨\n";
        std::cout << "   å±€éƒ¨è„šæœ¬å—ï¼šç‰¹æ®Šé€»è¾‘ä¸‹ï¼Œæ²¡æœ‰æ ·å¼å—æ—¶è‡ªåŠ¨æ·»åŠ {{.box}}/{{#box}}\n";
        std::cout << "\nğŸ”— å¼•ç”¨é€‰æ‹©å™¨è§„åˆ™:\n";
        std::cout << "   æ ·å¼å—&å¼•ç”¨ï¼šä¼˜å…ˆé€‰æ‹©class (.class)\n";
        std::cout << "   è„šæœ¬å—&å¼•ç”¨ï¼šä¼˜å…ˆé€‰æ‹©id ({{#id}})\n";
        std::cout << "\nâœ¨ ç‰¹æ®Šè¯´æ˜:\n";
        std::cout << "   {{box}}ä¸ä¼šè‡ªåŠ¨æ·»åŠ ï¼Œåªæœ‰{{.box}}å’Œ{{#box}}èƒ½å¤Ÿè§¦å‘è‡ªåŠ¨åŒ–\n";
        std::cout << "   å¼•ç”¨é€‰æ‹©å™¨&ä¼šæ ¹æ®ä¸Šä¸‹æ–‡è‡ªåŠ¨æ›¿æ¢ä¸ºåˆé€‚çš„é€‰æ‹©å™¨\n";
        std::cout << "   ç³»ç»Ÿå·²é›†æˆåˆ°CHTLç¼–è¯‘å™¨çš„Generatorä¸­\n";
        
        return 0;
    } catch (const std::exception& e) {
        std::cerr << "æµ‹è¯•å¤±è´¥: " << e.what() << std::endl;
        return 1;
    }
}